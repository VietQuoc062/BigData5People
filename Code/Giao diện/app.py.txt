import streamlit as st
import pandas as pd
import plotly.express as px
from wordcloud import WordCloud
import matplotlib.pyplot as plt
import os
import subprocess
import datetime

# ==============================
# ğŸ› ï¸ Cáº¥u hÃ¬nh vÃ  HÃ m chung
# ==============================
st.set_page_config(page_title="IT Job Data Visualization", layout="wide")
st.title("ğŸ“Š Há»† THá»NG TRá»°C QUAN HÃ“A Dá»® LIá»†U TUYá»‚N Dá»¤NG IT VIá»†T NAM")
st.markdown("PhiÃªn báº£n tá»•ng quan táº­p trung vÃ o cÃ¡c phÃ¢n tÃ­ch cá»‘t lÃµi vá» thá»‹ trÆ°á»ng.")

DATA_PATH = "Data/"
BACKUP_PATH = os.path.join(DATA_PATH, "backup")
os.makedirs(BACKUP_PATH, exist_ok=True)

# ==============================
# ğŸ›  HÃ m tiá»‡n Ã­ch
# ==============================
@st.cache_data
def load_all_data():
    files = {
        "salary_stat": "salary_stat.csv",
        "level_count": "level_count.csv",
        "domain_count": "domain_count.csv",
        "skill_count": "skill_count.csv",
        "salary_location": "salary_location.csv",
        "company_job_count": "company_job_count.csv",
    }
    dataframes = {}
    for key, filename in files.items():
        filepath = os.path.join(DATA_PATH, filename)
        try:
            df = pd.read_csv(filepath, sep=";", header=None)
        except UnicodeDecodeError:
            df = pd.read_csv(filepath, sep=";", encoding="cp1252", header=None)
        except FileNotFoundError:
            st.error(f"Lá»—i: KhÃ´ng tÃ¬m tháº¥y file {filename} trong thÆ° má»¥c '{DATA_PATH}'.")
            df = pd.DataFrame()
        dataframes[key] = df
    return dataframes

def clean_salary_column(series):
    series = series.astype(str).str.replace(" triá»‡u VND", "", regex=False)
    series = series.str.replace("thÆ°Æ¡ng lÆ°á»£ng", "", regex=False)
    series = series.str.replace(",", ".", regex=False)
    series = series.str.replace(r'[^\d\.\-]', '', regex=True)
    return pd.to_numeric(series, errors="coerce")

def convert_df_to_csv(df):
    return df.to_csv(index=False).encode('utf-8')

def backup_file(file_name):
    df = pd.read_csv(os.path.join(DATA_PATH, file_name))
    if df.empty:
        return None, None
    backup_dir = os.path.join(BACKUP_PATH, file_name.replace(".csv",""))
    os.makedirs(backup_dir, exist_ok=True)
    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_file_name = f"{file_name.replace('.csv','')}_{timestamp}.csv"
    backup_path = os.path.join(backup_dir, backup_file_name)
    df.to_csv(backup_path, index=False)
    return backup_file_name, backup_path

def restore_file(file_name, backup_file_name):
    backup_dir = os.path.join(BACKUP_PATH, file_name.replace(".csv",""))
    backup_path = os.path.join(backup_dir, backup_file_name)
    if not os.path.exists(backup_path):
        return False
    df = pd.read_csv(backup_path)
    df.to_csv(os.path.join(DATA_PATH, file_name), index=False)
    return True

# ==============================
# ğŸ”¹ Sidebar chá»n chá»©c nÄƒng
# ==============================
st.sidebar.header("Chá»n Chá»©c NÄƒng")
analysis_selection = st.sidebar.radio(
    "Chá»n má»™t nhÃ³m Ä‘á»ƒ xem chi tiáº¿t:",
    (
        "ğŸ’° PhÃ¢n TÃ­ch LÆ°Æ¡ng", 
        "ğŸ“ˆ PhÃ¢n TÃ­ch Nhu Cáº§u Tuyá»ƒn Dá»¥ng", 
        "ğŸ¢ ThÃ´ng Tin Thá»‹ TrÆ°á»ng", 
        "âš™ï¸ Quáº£n LÃ½ Data & final_cleaned", 
        "ğŸ”„ Quáº£n LÃ½ File HDFS",
        "ğŸ’¾ Backup & Restore"
    )
)

# ==============================
# ğŸ’° PhÃ¢n TÃ­ch LÆ°Æ¡ng
# ==============================
if analysis_selection == "ğŸ’° PhÃ¢n TÃ­ch LÆ°Æ¡ng":
    st.header("ğŸ’° PhÃ¢n TÃ­ch LÆ°Æ¡ng")
    df_salary = load_all_data()["salary_stat"].copy()
    if not df_salary.empty and len(df_salary.columns) >= 4:
        df_salary.columns = ["Job", "Count", "Variance", "Std"]
        for col in ["Count","Variance","Std"]:
            df_salary[col] = pd.to_numeric(df_salary[col].astype(str).str.replace(",", "", regex=False), errors="coerce").fillna(0)
        df_salary_nonzero = df_salary[df_salary["Std"]>0].sort_values("Std", ascending=False)
        top_n = st.slider("Top N cÃ´ng viá»‡c theo biáº¿n Ä‘á»™ng lÆ°Æ¡ng", 5, min(30,len(df_salary_nonzero)), 15)
        df_top = df_salary_nonzero.head(top_n)
        fig = px.bar(df_top, x="Job", y="Std", color="Std",
                     text=df_top["Std"].apply(lambda x:f"{x:,.0f}"), title=f"Top {top_n} cÃ´ng viá»‡c theo Ä‘á»™ lá»‡ch chuáº©n lÆ°Æ¡ng")
        fig.update_layout(xaxis_tickangle=-45, coloraxis_showscale=False, uniformtext_minsize=8, uniformtext_mode='hide')
        fig.update_traces(textposition='outside')
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.error("Dá»¯ liá»‡u salary_stat.csv khÃ´ng há»£p lá»‡")

    df_loc = load_all_data()["salary_location"].copy()
    if not df_loc.empty and len(df_loc.columns)>=3:
        df_loc.columns=["KhuVuc","SoLuongTin","LuongTB"]
        df_loc["LuongTB"]=clean_salary_column(df_loc["LuongTB"])
        df_loc.dropna(subset=["LuongTB"], inplace=True)
        df_loc = df_loc[df_loc["LuongTB"]>0].sort_values("LuongTB", ascending=False)
        fig_loc = px.bar(df_loc, x="KhuVuc", y="LuongTB", color="LuongTB",
                         title="Má»©c lÆ°Æ¡ng trung bÃ¬nh theo khu vá»±c (triá»‡u VND)")
        fig_loc.update_traces(texttemplate='%{y:.1f} tr', textposition='outside')
        st.plotly_chart(fig_loc, use_container_width=True)

# ==============================
# ğŸ“ˆ PhÃ¢n TÃ­ch Nhu Cáº§u Tuyá»ƒn Dá»¥ng
# ==============================
elif analysis_selection == "ğŸ“ˆ PhÃ¢n TÃ­ch Nhu Cáº§u Tuyá»ƒn Dá»¥ng":
    st.header("ğŸ“ˆ PhÃ¢n TÃ­ch Nhu Cáº§u Tuyá»ƒn Dá»¥ng")
    df_level = load_all_data()["level_count"].copy()
    if not df_level.empty and len(df_level.columns)>=2:
        df_level.columns=["CapDo","SoLuong"]
        df_level["SoLuong"]=pd.to_numeric(df_level["SoLuong"], errors="coerce").fillna(0)
        df_level = df_level[df_level["SoLuong"]>0]
        fig = px.pie(df_level, names="CapDo", values="SoLuong", hole=0.4, title="Tá»· lá»‡ nhu cáº§u theo cáº¥p Ä‘á»™")
        fig.update_traces(textinfo='percent+label')
        st.plotly_chart(fig, use_container_width=True)

    df_domain = load_all_data()["domain_count"].copy()
    if not df_domain.empty and len(df_domain.columns)>=2:
        df_domain.columns=["LinhVuc","SoLuong"]
        df_domain["SoLuong"]=pd.to_numeric(df_domain["SoLuong"], errors="coerce").fillna(0)
        top_n = st.slider("Top N lÄ©nh vá»±c",5,15,8,key="domain_slider")
        df_top = df_domain.sort_values("SoLuong", ascending=False).head(top_n)
        fig = px.bar(df_top, x="SoLuong", y="LinhVuc", orientation='h', color="SoLuong",
                     title=f"Top {top_n} lÄ©nh vá»±c cÃ³ nhu cáº§u tuyá»ƒn dá»¥ng nhiá»u nháº¥t")
        st.plotly_chart(fig, use_container_width=True)

    df_skill = load_all_data()["skill_count"].copy()
    if not df_skill.empty and len(df_skill.columns)>=2:
        df_skill.columns=["KyNang","SoLuong"]
        df_skill["SoLuong"]=pd.to_numeric(df_skill["SoLuong"], errors="coerce").fillna(0)
        top_skills = df_skill.sort_values("SoLuong", ascending=False).head(100)
        wc_dict = top_skills.set_index("KyNang")["SoLuong"].to_dict()
        wc = WordCloud(width=800,height=400, background_color="white", max_words=100,colormap='viridis').generate_from_frequencies(wc_dict)
        fig,ax = plt.subplots(figsize=(12,6))
        ax.imshow(wc, interpolation="bilinear")
        ax.axis("off")
        st.pyplot(fig)

# ==============================
# ğŸ¢ ThÃ´ng Tin Thá»‹ TrÆ°á»ng
# ==============================
elif analysis_selection == "ğŸ¢ ThÃ´ng Tin Thá»‹ TrÆ°á»ng":
    st.header("ğŸ¢ ThÃ´ng Tin Thá»‹ TrÆ°á»ng")
    df_company = load_all_data()["company_job_count"].copy()
    if not df_company.empty and len(df_company.columns)>=2:
        df_company.columns=["CongTy","SoLuongTin"]
        df_company["SoLuongTin"]=pd.to_numeric(df_company["SoLuongTin"], errors="coerce").fillna(0)
        top_n = st.slider("Top N cÃ´ng ty",5,30,15,key="company_slider")
        df_top = df_company.sort_values("SoLuongTin", ascending=False).head(top_n)
        fig = px.bar(df_top, x="SoLuongTin", y="CongTy", orientation='h', color="SoLuongTin",
                     title=f"Top {top_n} cÃ´ng ty cÃ³ nhiá»u tin tuyá»ƒn dá»¥ng nháº¥t")
        st.plotly_chart(fig, use_container_width=True)

# ==============================
# âš™ï¸ Quáº£n LÃ½ Data & final_cleaned
# ==============================
elif analysis_selection == "âš™ï¸ Quáº£n LÃ½ Data & final_cleaned":
    st.header("âš™ï¸ Quáº£n LÃ½ & Chá»‰nh Sá»­a File 'final_cleaned.csv'")
    FINAL_FILE = os.path.join(DATA_PATH,"final_cleaned.csv")
    HDFS_PATH = "hdfs://localhost:9000/input/final_cleaned.csv"
    try:
        df_final = pd.read_csv(FINAL_FILE)
    except:
        df_final=pd.DataFrame()
    if not df_final.empty:
        search_term = st.text_input("TÃ¬m kiáº¿m trong báº£ng:").strip()
        df_display = df_final.copy()
        if search_term:
            mask = df_display.apply(lambda row: row.astype(str).str.contains(search_term, case=False).any(), axis=1)
            df_display=df_display[mask]
        st.markdown("### âœï¸ Chá»‰nh sá»­a dá»¯ liá»‡u trá»±c tiáº¿p")
        edited_df = st.data_editor(df_display,num_rows="dynamic", use_container_width=True)
        if st.button("ğŸ’¾ LÆ°u thay Ä‘á»•i vÃ o file local"):
            if search_term:
                for idx in edited_df.index:
                    df_final.loc[idx]=edited_df.loc[idx]
            else:
                df_final=edited_df.copy()
            df_final.to_csv(FINAL_FILE,index=False)
            st.success(f"âœ… ÄÃ£ lÆ°u file final_cleaned.csv táº¡i {FINAL_FILE}")
        st.markdown("### â¬†ï¸ Cáº­p nháº­t file lÃªn HDFS")
        if st.button("ğŸš€ Cáº­p nháº­t lÃªn HDFS"):
            try:
                df_final.to_csv(FINAL_FILE,index=False)
                cmd=f"hdfs dfs -put -f {FINAL_FILE} {HDFS_PATH}"
                subprocess.run(cmd, shell=True, check=True)
                st.success(f"âœ… ÄÃ£ cáº­p nháº­t file lÃªn HDFS: {HDFS_PATH}")
            except subprocess.CalledProcessError as e:
                st.error(f"âŒ Lá»—i khi cáº­p nháº­t lÃªn HDFS: {e}")

# ==============================
# ğŸ”„ Quáº£n LÃ½ File HDFS
# ==============================
elif analysis_selection == "ğŸ”„ Quáº£n LÃ½ File HDFS":
    st.header("ğŸ”„ Quáº£n LÃ½ File HDFS")
    LOCAL_DATA_PATH = DATA_PATH
    st.subheader("1ï¸âƒ£ Import tá»« HDFS vá» local")
    hdfs_file_to_import = st.text_input("ÄÆ°á»ng dáº«n file HDFS:", value="/input/final_cleaned.csv", key="import_hdfs")
    if st.button("â¬‡ï¸ Táº£i vá» local"):
        local_target = os.path.join(LOCAL_DATA_PATH, os.path.basename(hdfs_file_to_import))
        try:
            cmd = f"hdfs dfs -get -f {hdfs_file_to_import} {local_target}"
            subprocess.run(cmd, shell=True, check=True)
            st.success(f"âœ… File Ä‘Ã£ Ä‘Æ°á»£c táº£i vá»: {local_target}")
        except subprocess.CalledProcessError as e:
            st.error(f"âŒ Lá»—i khi táº£i file tá»« HDFS: {e}")

    st.markdown("---")
    st.subheader("2ï¸âƒ£ Export tá»« local lÃªn HDFS")
    local_files = [f for f in os.listdir(LOCAL_DATA_PATH) if os.path.isfile(os.path.join(LOCAL_DATA_PATH,f))]
    file_to_export = st.selectbox("Chá»n file local Ä‘á»ƒ upload:", local_files, key="export_local")
    hdfs_target_path = st.text_input("ÄÆ°á»ng dáº«n Ä‘Ã­ch trÃªn HDFS:", value="/input/", key="export_hdfs")
    if st.button("â¬†ï¸ Upload lÃªn HDFS"):
        local_path = os.path.join(LOCAL_DATA_PATH, file_to_export)
        hdfs_full_path = os.path.join(hdfs_target_path, file_to_export)
        try:
            cmd = f"hdfs dfs -put -f {local_path} {hdfs_full_path}"
            subprocess.run(cmd, shell=True, check=True)
            st.success(f"âœ… File Ä‘Ã£ Ä‘Æ°á»£c upload lÃªn HDFS: {hdfs_full_path}")
        except subprocess.CalledProcessError as e:
            st.error(f"âŒ Lá»—i khi upload file lÃªn HDFS: {e}")

# ==============================
# ğŸ’¾ Backup & Restore
# ==============================
elif analysis_selection == "ğŸ’¾ Backup & Restore":
    st.header("ğŸ’¾ Backup & Restore File CSV")

    csv_files = [f for f in os.listdir(DATA_PATH) if f.endswith(".csv")]
    file_selected = st.selectbox("Chá»n file muá»‘n backup/restore:", csv_files, key="backup_file_select")

    st.subheader("1ï¸âƒ£ Backup file local")
    if st.button("ğŸ’¾ Táº¡o backup"):
        backup_name, backup_path = backup_file(file_selected)
        if backup_name:
            st.success(f"âœ… ÄÃ£ táº¡o backup: {backup_name} táº¡i {backup_path}")
        else:
            st.warning("âŒ File rá»—ng, khÃ´ng thá»ƒ backup.")

    st.subheader("2ï¸âƒ£ Restore tá»« local backup")
    backup_dir = os.path.join(BACKUP_PATH, file_selected.replace(".csv",""))
    backups = []
    if os.path.exists(backup_dir):
        backups = [f for f in os.listdir(backup_dir) if f.endswith(".csv")]
    restore_backup = st.selectbox("Chá»n backup Ä‘á»ƒ restore:", backups, key="restore_backup")
    if st.button("â™»ï¸ Restore file"):
        if restore_file(file_selected, restore_backup):
            st.success(f"âœ… ÄÃ£ restore {file_selected} tá»« backup {restore_backup}")
        else:
            st.error("âŒ Lá»—i restore file")


# ==============================
# Footer
# ==============================
st.markdown("---")
st.caption("Â© 2025 - IT Job Data Visualization | Nguá»“n dá»¯ liá»‡u: itviec.com & topdev.vn")
